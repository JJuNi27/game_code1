import random

# í”Œë ˆì´ì–´ í´ë˜ìŠ¤
class Player:
    def __init__(self, name):
        self.name = name
        self.health = 100
        self.attack = 20
        self.defense = 10
        self.coins = 0
        self.items = []

    def show_stats(self):
        print("\nğŸ“œ [í”Œë ˆì´ì–´ ëŠ¥ë ¥ì¹˜]")
        print(f"â¤ï¸ ì²´ë ¥: {self.health}")
        print(f"âš”ï¸ ê³µê²©ë ¥: {self.attack}")
        print(f"ğŸ›¡ï¸ ë°©ì–´ë ¥: {self.defense}")
        print(f"ğŸ’° ì¬í™”: {self.coins}ì›")
        print(f"ğŸ’ ë³´ìœ  ì•„ì´í…œ: {self.items if self.items else 'ì—†ìŒ'}\n")

    def attack_monster(self, monster):
        damage = self.attack
        monster.health -= damage
        print(f"âš”ï¸ í”Œë ˆì´ì–´ì˜ ê³µê²©! ëª¬ìŠ¤í„°ì—ê²Œ {damage}ë§Œí¼ ë°ë¯¸ì§€ ì£¼ì—ˆìŒ. ëª¬ìŠ¤í„° ì²´ë ¥: {monster.health}")

    def heal(self):
        self.health = 100
        print("ğŸ€ ì²´ë ¥ì´ ê°€ë“ ì°¨ì„œ ì™„ì „íˆ íšŒë³µí–ˆìŠµë‹ˆë‹¤!")

    def buy_item(self, item):
        self.items.append(item)
        print(f"ğŸ›ï¸ {item.name}ì„(ë¥¼) êµ¬ë§¤í–ˆìŠµë‹ˆë‹¤!")

    def lose_stats_on_death(self):
        self.attack = max(5, self.attack - 5)
        self.defense = max(5, self.defense - 3)
        print("âš ï¸ ëŠ¥ë ¥ì¹˜ê°€ ì¼ë¶€ ê°ì†Œí–ˆìŠµë‹ˆë‹¤! ê³µê²©ë ¥ê³¼ ë°©ì–´ë ¥ì´ ì¤„ì–´ë“¤ì—ˆìŠµë‹ˆë‹¤.")

# ëª¬ìŠ¤í„° í´ë˜ìŠ¤
class Monster:
    def __init__(self, name, health, attack, grade):
        self.name = name
        self.health = health
        self.attack = attack
        self.grade = grade
        self.coins = self.calculate_coins()

    def calculate_coins(self):
        if self.grade == "ì¼ë°˜":
            return random.randint(1, 3)
        elif self.grade == "ë ˆì–´":
            return random.randint(4, 7)
        else:  # ë³´ìŠ¤
            return random.randint(8, 15)

    def show_stats(self):
        print(f"ğŸ‘¹ ëª¬ìŠ¤í„° ì´ë¦„: {self.name}")
        print(f"ë“±ê¸‰: {self.grade}")
        print(f"â¤ï¸ ì²´ë ¥: {self.health}")
        print(f"âš”ï¸ ê³µê²©ë ¥: {self.attack}")
        print(f"ğŸ’° ì£¼ëŠ” ì¬í™”: {self.coins}ì›")

    def attack_player(self, player):
        damage = self.attack
        player.health -= damage
        print(f"ğŸ’¥ ëª¬ìŠ¤í„°ì˜ ê³µê²©! {damage}ë§Œí¼ ë°ë¯¸ì§€ ë°›ìŒ. ì²´ë ¥: {player.health}")

    def drop_item(self):
        drop_chance = random.random()
        if self.grade == "ë³´ìŠ¤" and drop_chance < 0.7:  # ë³´ìŠ¤ëŠ” ë†’ì€ í™•ë¥ ë¡œ ì „ì„¤ ì•„ì´í…œì„ ë“œë
            return random.choice(legendary_items)
        elif self.grade == "ë ˆì–´" and drop_chance < 0.5:  # ë ˆì–´ ëª¬ìŠ¤í„°ëŠ” í™•ë¥  50%ë¡œ ì—í”½ ì•„ì´í…œì„ ë“œë
            return random.choice(epic_items)
        elif self.grade == "ì¼ë°˜" and drop_chance < 0.3:  # ì¼ë°˜ ëª¬ìŠ¤í„°ëŠ” í™•ë¥  30%ë¡œ ë…¸ë§ ì•„ì´í…œì„ ë“œë
            return random.choice(normal_items)
        return None  # ì•„ë¬´ê²ƒë„ ë“œëí•˜ì§€ ì•ŠìŒ

# ì•„ì´í…œ í´ë˜ìŠ¤
class Item:
    def __init__(self, name, grade, effect):
        self.name = name
        self.grade = grade
        self.effect = effect

    def __repr__(self):
        return f"{self.name} ({self.grade})"

# ì•„ì´í…œ ìƒì„±
normal_items = [
    Item("ìŠ¬ê¸°ë¡œìš´ ì² ê²€", "ë…¸ë§", "ê³µê²©ë ¥ 5 ì¦ê°€"),
    Item("íŠ¼íŠ¼í•œ ë°©íŒ¨", "ë…¸ë§", "ë°©ì–´ë ¥ 5 ì¦ê°€"),
    Item("ê±´ê°•í•œ ë¬¼ì•½", "ë…¸ë§", "ì²´ë ¥ 20 íšŒë³µ"),
    Item("ë‹¨ë‹¨í•œ ê°‘ì˜·", "ë…¸ë§", "ë°©ì–´ë ¥ 7 ì¦ê°€"),
    Item("ìƒê¸‰ ì²´ë ¥ ë¬¼ì•½", "ë…¸ë§", "ì²´ë ¥ 40 íšŒë³µ"),
    Item("ë¶ˆì‚¬ì˜ ë¬¼ì•½", "ë…¸ë§", "ì²´ë ¥ 100 íšŒë³µ"),
    Item("ë§ˆë ¥ì˜ ê²€", "ë…¸ë§", "ê³µê²©ë ¥ 10 ì¦ê°€"),
]

epic_items = [
    Item("ë§ˆë²•ì˜ ì² ê²€", "ì—í”½", "ê³µê²©ë ¥ 10 ì¦ê°€"),
    Item("ë¶ˆì‚¬ì˜ ë°©íŒ¨", "ì—í”½", "ë°©ì–´ë ¥ 10 ì¦ê°€"),
    Item("íšŒë³µì˜ ë¬¼ì•½", "ì—í”½", "ì²´ë ¥ 50 íšŒë³µ"),
    Item("ì–´ë‘ ì˜ ë°©íŒ¨", "ì—í”½", "ë°©ì–´ë ¥ 12 ì¦ê°€"),
    Item("ì¹˜ëª…ì ì¸ ê²€", "ì—í”½", "ê³µê²©ë ¥ 15 ì¦ê°€"),
    Item("ëŒ€ë§ˆë²•ì‚¬ì˜ ë¬¼ì•½", "ì—í”½", "ì²´ë ¥ 80 íšŒë³µ"),
    Item("ë¶ˆì‚¬ì‹ ì˜ ê²€", "ì—í”½", "ê³µê²©ë ¥ 20 ì¦ê°€"),
]

legendary_items = [
    Item("ì²œìƒì˜ ê²€", "ì „ì„¤", "ê³µê²©ë ¥ 20 ì¦ê°€"),
    Item("ë¶ˆë©¸ì˜ ë°©íŒ¨", "ì „ì„¤", "ë°©ì–´ë ¥ 20 ì¦ê°€"),
    Item("ì—˜ë¦­ì„œ", "ì „ì„¤", "ì²´ë ¥ 100 íšŒë³µ"),
    Item("ì‹ ì˜ ê²€", "ì „ì„¤", "ê³µê²©ë ¥ 30 ì¦ê°€"),
    Item("ë¶ˆì‚¬ì˜ ë°©íŒ¨", "ì „ì„¤", "ë°©ì–´ë ¥ 30 ì¦ê°€"),
    Item("ì²œìƒì˜ ë¬¼ì•½", "ì „ì„¤", "ì²´ë ¥ 150 íšŒë³µ"),
    Item("ì˜ì›ì˜ ê²€", "ì „ì„¤", "ê³µê²©ë ¥ 40 ì¦ê°€"),
]

# ì œë ¨ì†Œ í´ë˜ìŠ¤ (ì•„ì´í…œ í•©ì„± ê¸°ëŠ¥ ì¶”ê°€)
class Refinery:
    def __init__(self):
        self.available_items = []  # ì œë ¨ì†Œì— ìˆëŠ” ì•„ì´í…œ ëª©ë¡

    # ì œë ¨ì†Œì— ì•„ì´í…œ ì¶”ê°€
    def add_item(self, item):
        self.available_items.append(item)

    # ê°™ì€ ë“±ê¸‰ì˜ ì•„ì´í…œ 2ê°œë¥¼ ì„ íƒí•´ í•©ì„±
    def refine_items(self, grade):
        same_grade_items = [item for item in self.available_items if item.grade == grade]
        
        # ê°™ì€ ë“±ê¸‰ ì•„ì´í…œì´ 2ê°œ ì´ìƒ ìˆëŠ”ì§€ í™•ì¸
        if len(same_grade_items) < 2:
            print(f"ê°™ì€ ë“±ê¸‰ì˜ ì•„ì´í…œì´ ë¶€ì¡±í•©ë‹ˆë‹¤. {grade} ë“±ê¸‰ ì•„ì´í…œì„ ë‘ ê°œ ì´ìƒ ì†Œì§€í•´ì•¼ í•©ì„±ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.")
            return None
        
        # ë‘ ê°œ ì•„ì´í…œ ì„ íƒ
        item1, item2 = random.sample(same_grade_items, 2)

        # ì„ íƒí•œ ì•„ì´í…œì„ í•©ì„±
        self.available_items.remove(item1)
        self.available_items.remove(item2)

        # ìƒìœ„ ë“±ê¸‰ ì•„ì´í…œ ëœë¤ ìƒì„± (ì˜ˆ: ë…¸ë§ -> ì—í”½, ì—í”½ -> ì „ì„¤)
        new_item = self.create_random_item(grade)
        
        # ìƒˆë¡œ ìƒì„±ëœ ì•„ì´í…œì„ ì œë ¨ì†Œì— ì¶”ê°€
        self.add_item(new_item)

        print(f"í•©ì„± ì™„ë£Œ! '{item1.name}'ê³¼ '{item2.name}'ì´ í•©ì³ì ¸ '{new_item.name}' ì•„ì´í…œì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.")
        return new_item
    
    # ìƒìœ„ ë“±ê¸‰ ì•„ì´í…œ ëœë¤ ìƒì„±
    def create_random_item(self, grade):
        if grade == "ë…¸ë§":
            return self.random_upgrade("ì—í”½")
        elif grade == "ì—í”½":
            return self.random_upgrade("ì „ì„¤")
        elif grade == "ì „ì„¤":
            print("ì „ì„¤ ë“±ê¸‰ ì•„ì´í…œì€ ë” ì´ìƒ ì—…ê·¸ë ˆì´ë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
            return None

    # ìƒìœ„ ë“±ê¸‰ ì•„ì´í…œ ëœë¤ ìƒì„±
    def random_upgrade(self, new_grade):
        if new_grade == "ì—í”½":
            return random.choice(epic_items)
        elif new_grade == "ì „ì„¤":
            return random.choice(legendary_items)

# ğŸ² í™€ì§ ê²Œì„
def dice_game():
    print("ğŸ² í™€ì§ ê²Œì„! (ì£¼ì‚¬ìœ„ êµ´ë¦¬ê¸°)")
    guess = input("í™€(h) ë˜ëŠ” ì§(e) ì„ íƒ: ").lower()
    roll = random.randint(1, 6)
    print(f"ğŸ² ì£¼ì‚¬ìœ„ ê²°ê³¼: {roll}")
    return (roll % 2 == 0 and guess == 'e') or (roll % 2 == 1 and guess == 'h')

# âœŠâœ‹âœŒï¸ ê°€ìœ„ë°”ìœ„ë³´ ê²Œì„
def rock_paper_scissors():
    print("âœŠâœ‹âœŒï¸ ê°€ìœ„ë°”ìœ„ë³´ ê²Œì„!")
    choices = ["ê°€ìœ„", "ë°”ìœ„", "ë³´"]
    player_choice = input("ê°€ìœ„, ë°”ìœ„, ë³´ ì¤‘ ì„ íƒ: ")
    monster_choice = random.choice(choices)
    print(f"ğŸ‘¹ ëª¬ìŠ¤í„°: {monster_choice}")

    if player_choice == monster_choice:
        print("âš–ï¸ ë¬´ìŠ¹ë¶€! ë‹¤ì‹œ ë„ì „!")
        return rock_paper_scissors()
    elif (player_choice == "ê°€ìœ„" and monster_choice == "ë³´") or \
         (player_choice == "ë°”ìœ„" and monster_choice == "ê°€ìœ„") or \
         (player_choice == "ë³´" and monster_choice == "ë°”ìœ„"):
        return True
    else:
        return False

# ğŸ¹ ì „íˆ¬ ì‹œìŠ¤í…œ
def battle(player, monster):
    print("\nâš”ï¸ ëª¬ìŠ¤í„°ì™€ì˜ ì „íˆ¬ ì‹œì‘!")

    mini_games = [
        dice_game, rock_paper_scissors
    ]

    while monster.health > 0:
        print("\nğŸ”¥ ë¯¸ë‹ˆê²Œì„ ë„ì „!")
        game = random.choice(mini_games)

        if game():  # ë¯¸ë‹ˆê²Œì„ì—ì„œ ìŠ¹ë¦¬ ì‹œ
            print("ğŸ‰ ìŠ¹ë¦¬! ëª¬ìŠ¤í„°ì—ê²Œ ê³µê²© ì„±ê³µ!")
            player.attack_monster(monster)
        else:  # ë¯¸ë‹ˆê²Œì„ì—ì„œ íŒ¨ë°° ì‹œ
            print("ğŸ’¥ íŒ¨ë°°! ëª¬ìŠ¤í„°ì˜ ê³µê²©!")
            monster.attack_player(player)

        if player.health <= 0:
            print("ğŸ’€ í”Œë ˆì´ì–´ê°€ ì‚¬ë§í–ˆìŠµë‹ˆë‹¤...")
            player.lose_stats_on_death()
            return False  # ê²Œì„ ì¢…ë£Œ

    print(f"ğŸŠ ëª¬ìŠ¤í„° ì²˜ì¹˜ ì™„ë£Œ! +{monster.coins} ì¬í™” íšë“!")
    player.coins += monster.coins

    # ëª¬ìŠ¤í„° ë“œë ì•„ì´í…œ (ëª¬ìŠ¤í„° ë“±ê¸‰ì— ë”°ë¼ ë“œë í™•ë¥  ë‹¤ë¥´ê²Œ ì„¤ì •)
    drop_item = monster.drop_item()
    if drop_item:
        print(f"ğŸ {monster.name}ì´(ê°€) '{drop_item.name}' ì•„ì´í…œì„ ë“œëí–ˆìŠµë‹ˆë‹¤!")
        player.buy_item(drop_item)

    # ì „íˆ¬ ëë‚œ í›„ ì—”í„°ë¥¼ ëˆ„ë¥¼ ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼
    input("ì „íˆ¬ê°€ ëë‚¬ìŠµë‹ˆë‹¤. ë‹¤ìŒìœ¼ë¡œ ë„˜ì–´ê°€ë ¤ë©´ Enterë¥¼ ëˆ„ë¥´ì„¸ìš”...")

    return True  # ëª¬ìŠ¤í„° ì²˜ì¹˜ í›„ ì „íˆ¬ ì¢…ë£Œ

# ğŸ° ë˜ì „ íƒí—˜
def dungeon(player):
    refinery = Refinery()
    while player.health > 0:
        print("\nğŸ” ë˜ì „ íƒí—˜ ì¤‘...")
        event = random.choices(["monster", "shop", "rest", "trap", "refinery"], [0.5, 0.2, 0.2, 0.1, 0.1])[0]
        
        if event == "monster":
            monster_name = random.choice(["ì•…ëª½ì˜ ê´´ë¬¼", "ì§€ì˜¥ì˜ ì‚¬ì", "êµ¬ë¦„ì˜ ë§ˆì™•", "ë¶ˆì‚¬ì˜ ê´´ë¬¼", "ì–´ë‘ ì˜ ì§€ë°°ì"])
            grade = random.choice(["ì¼ë°˜", "ë ˆì–´", "ë³´ìŠ¤"])
            if grade == "ì¼ë°˜":
                monster = Monster(monster_name, health=30, attack=5, grade="ì¼ë°˜")
            elif grade == "ë ˆì–´":
                monster = Monster(monster_name, health=50, attack=10, grade="ë ˆì–´")
            else:  # ë³´ìŠ¤
                monster = Monster(monster_name, health=100, attack=20, grade="ë³´ìŠ¤")

            monster.show_stats()
            if not battle(player, monster):
                restart = input("ê²Œì„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/n): ").lower()
                if restart == "y":
                    player.health = 100
                    continue
                else:
                    break
        elif event == "shop":
            print("\nğŸ›’ ìƒì ì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤!")
            shop_items = normal_items + epic_items + legendary_items
            print("ìƒì  ì•„ì´í…œ:", [item.name for item in shop_items])
            item_choice = input("ì•„ì´í…œì„ êµ¬ë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/n): ").lower()
            if item_choice == "y":
                item = random.choice(shop_items)
                player.buy_item(item)
        elif event == "rest":
            print("\nğŸ’¤ ì‰¼í„°ì—ì„œ íœ´ì‹ì„ ì·¨í•©ë‹ˆë‹¤.")
            player.heal()
        elif event == "trap":
            print("\nâš ï¸ í•¨ì •ì— ë¹ ì¡ŒìŠµë‹ˆë‹¤! ì²´ë ¥ 20 ê°ì†Œ!")
            player.health -= 20
        elif event == "refinery":
            print("\nğŸ› ï¸ ì œë ¨ì†Œì— ë„ì°©í–ˆìŠµë‹ˆë‹¤. ì•„ì´í…œ í•©ì„±!")
            item_grade = input("í•©ì„±í•  ì•„ì´í…œ ë“±ê¸‰ì„ ì…ë ¥í•˜ì„¸ìš” (ë…¸ë§, ì—í”½, ì „ì„¤): ").lower()
            new_item = refinery.refine_items(item_grade.capitalize())
            if new_item:
                print(f"ì œë ¨ì†Œì—ì„œ í•©ì„±ëœ ì•„ì´í…œ: {new_item.name}")

# ê²Œì„ ì‹œì‘
def main():
    print("âš”ï¸ ë˜ì „ ëª¨í—˜ ê²Œì„ ì‹œì‘!")
    player_name = input("í”Œë ˆì´ì–´ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”: ")
    player = Player(player_name)
    
    dungeon(player)  # ë˜ì „ íƒí—˜ ì‹œì‘

if __name__ == "__main__":
    main()
